name: ðŸš€ Build Windows EXE & MSI

on:
  release:
    types: [published]

permissions:
  contents: write

jobs:
  build:
    runs-on: windows-latest

    steps:
      - name: ðŸ“¥ Checkout
        uses: actions/checkout@v4

      # -------------------------------
      # Extract version from release tag
      # Example: v1.2.3 â†’ 1.2.3
      # -------------------------------
      - name: ðŸ”¢ Extract Version
        shell: bash
        run: |
          VERSION=${GITHUB_REF#refs/tags/}
          VERSION=${VERSION#v}
          echo "VERSION=$VERSION" >> $GITHUB_ENV

      - name: â˜• Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 21

      - name: ðŸ›  Setup Gradle
        uses: gradle/actions/setup-gradle@v3
        with:
          cache-disabled: true


      # -------------------------------
      # Build with dynamic version
      # -------------------------------
      - name: ðŸ”¨ Build Fat JAR
        run: ./gradlew clean build -Pversion=$VERSION

      # -------------------------------
      # Detect built JAR automatically
      # -------------------------------
      - name: ðŸ“¦ Detect JAR Name
        shell: bash
        run: |
          JAR_FILE=$(ls build/libs/*.jar | head -n 1)
          echo "JAR_FILE=$JAR_FILE" >> $GITHUB_ENV

      # -------------------------------
      # Create EXE
      # -------------------------------
      - name: ðŸ“¦ Create EXE
        run: |
          jpackage ^
            --type exe ^
            --input build\libs ^
            --name DownloadManager ^
            --main-jar %JAR_FILE% ^
            --main-class manager.Main ^
            --dest dist ^
            --app-version %VERSION% ^
            --vendor "Rachakonda Ravi" ^
            --description "Modern Java Download Manager" ^
            --icon assets\icon.ico

      # -------------------------------
      # Create MSI
      # -------------------------------
      - name: ðŸ“¦ Create MSI
        run: |
          jpackage ^
            --type msi ^
            --input build\libs ^
            --name DownloadManager ^
            --main-jar %JAR_FILE% ^
            --main-class manager.Main ^
            --dest dist ^
            --app-version %VERSION% ^
            --vendor "Rachakonda Ravi" ^
            --description "Modern Java Download Manager" ^
            --icon assets\icon.ico ^
            --win-menu ^
            --win-shortcut

      # -------------------------------
      # Create Portable ZIP (versioned)
      # -------------------------------
      - name: ðŸ“¦ Create Portable ZIP
        run: |
          mkdir portable
          xcopy dist\DownloadManager portable\DownloadManager /E /I
          powershell Compress-Archive `
            -Path portable\DownloadManager `
            -DestinationPath dist\DownloadManager-%VERSION%-Portable.zip

      # -------------------------------
      # Upload All Assets
      # -------------------------------
      - name: ðŸ“¤ Upload Release Assets
        uses: softprops/action-gh-release@v2
        with:
          files: |
            dist/*.exe
            dist/*.msi
            dist/*.zip
