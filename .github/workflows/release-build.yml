name: ðŸš€ Build Windows EXE & MSI

on:
  release:
    types: [published]

permissions:
  contents: write

jobs:
  build:
    runs-on: windows-latest

    steps:
      - name: ðŸ“¥ Checkout
        uses: actions/checkout@v4

      # -------------------------------
      # Extract version from release tag
      # -------------------------------
      - name: ðŸ”¢ Extract Version
        shell: bash
        run: |
          VERSION=${GITHUB_REF#refs/tags/}
          VERSION=${VERSION#v}
          echo "VERSION=$VERSION" >> $GITHUB_ENV

      - name: â˜• Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 21

      - name: ðŸ›  Setup Gradle
        uses: gradle/actions/setup-gradle@v3
        with:
          cache-disabled: true

      # -------------------------------
      # Build Fat JAR
      # -------------------------------
      - name: ðŸ”¨ Build Fat JAR
        shell: bash
        run: ./gradlew clean build -Pversion=$VERSION

      # -------------------------------
      # Detect JAR name (only filename!)
      # -------------------------------
      - name: ðŸ“¦ Detect JAR Name
        shell: bash
        run: |
          JAR_FILE=$(ls build/libs/*.jar | grep -v plain | head -n 1)
          JAR_FILE=$(basename "$JAR_FILE")
          echo "JAR_FILE=$JAR_FILE" >> $GITHUB_ENV


      # -------------------------------
      # Clean dist folder
      # -------------------------------
      - name: ðŸ§¹ Clean dist
        shell: cmd
        run: |
          if exist dist rmdir /s /q dist


      - name: ðŸ“¦ Create App Image (Portable Base)
        shell: cmd
        run: |
          jpackage ^
            --type app-image ^
            --input build\libs ^
            --name DownloadManager ^
            --main-jar %JAR_FILE% ^
            --main-class manager.Main ^
            --dest dist ^
            --app-version %VERSION% ^
            --vendor "Rachakonda Ravi" ^
            --description "Modern Java Download Manager" ^
            --icon assets\icon.ico

      # -------------------------------
      # Create EXE (use CMD shell!)
      # -------------------------------
      - name: ðŸ“¦ Create EXE
        shell: cmd
        run: |
          jpackage ^
            --type exe ^
            --input build\libs ^
            --name DownloadManager ^
            --main-jar %JAR_FILE% ^
            --main-class manager.Main ^
            --dest dist ^
            --app-version %VERSION% ^
            --vendor "Rachakonda Ravi" ^
            --description "Modern Java Download Manager" ^
            --icon assets\icon.ico

      # -------------------------------
      # Create MSI
      # -------------------------------
      - name: ðŸ“¦ Create MSI
        shell: cmd
        run: |
          jpackage ^
            --type msi ^
            --input build\libs ^
            --name DownloadManager ^
            --main-jar %JAR_FILE% ^
            --main-class manager.Main ^
            --dest dist ^
            --app-version %VERSION% ^
            --vendor "Rachakonda Ravi" ^
            --description "Modern Java Download Manager" ^
            --icon assets\icon.ico ^
            --win-menu ^
            --win-shortcut

      # -------------------------------
      # Create Portable ZIP
      # -------------------------------
      - name: ðŸ“¦ Create Portable ZIP
        shell: powershell
        run: |
          Compress-Archive `
            -Path dist\DownloadManager `
            -DestinationPath dist\DownloadManager-$env:VERSION-Portable.zip

      # -------------------------------
      # Upload All Assets
      # -------------------------------
      - name: ðŸ“¤ Upload Release Assets
        uses: softprops/action-gh-release@v2
        with:
          files: |
            dist/*.exe
            dist/*.msi
            dist/*.zip
